version: "3.9"

services:
  backend:
    build:
      context: ./DigitalTwinDotNetBackend
      dockerfile: ./Dockerfile
    container_name: twin_backend
    restart: unless-stopped
    environment:
      ASPNETCORE_URLS: http://0.0.0.0:5251
      Postgres__ConnectionString: "Host=206.180.209.81;Port=5432;Username=twin;Password=twinpass;Database=twin;"
      Redis__ConnectionString: "206.180.209.81:6379,abortConnect=false"

      Proxy__BaseUrl: "https://bambu.gumaker.space"
      Proxy__ApiKey: "38b26ddf-1ac3-4d89-af21-157aa66f7d94"
      Proxy__TimeoutSeconds: "10"
      Proxy__MaxRetries: "4"
    expose:
      - "5251"
    networks: [twin_net]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5251/health/live"]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 30s

  nginx:
    image: nginx:1.27-alpine
    container_name: twin_nginx
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "127.0.0.1:80:80"
    volumes:
      - ./ops/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks: [twin_net]

networks:
  twin_net:
